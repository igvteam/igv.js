<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>IGV - Dev</title>

    <style>
        #trackList {

            border-color: rgb(127, 127, 127);
            border-style: solid;
            border-width: thin;

            width: 480px;
            height: 256px;
            overflow-y: auto;
        }

        div#trackList > div, div#myDiv > h3 {

            font-family: 'PT Sans', sans-serif;
            font-size: small;
            font-weight: 400;

            color: #444;
            margin-left: 16px;
            margin-top: 4px;
            margin-bottom: 4px;

            padding-left: 32px;
        }

        div#myDiv > h3 {
            font-size: large;
        }

        div#trackList > div:hover,
        div#trackList > div:focus,
        div#trackList > div:active {
            cursor: pointer;
            color: white;
            background-color: rgba(49, 106, 246, 1);
        }

    </style>

</head>

<body>

<div>
    <button id="bmBtn">Bookmark</button>
    <button id="sessionButton">Save Session</button>
</div>

<h3>Example tracks - click to load</h3>



<div id="trackList"></div>

<div id="igvDiv" style="padding-top: 50px;padding-bottom: 20px; height: auto"></div>

</body>

<script type="module">

    import igv from '../js/index.js'
    import GtexUtils from '../js/gtex/gtexUtils.js'
    import { igvxhr } from '../node_modules/igv-utils/src/index.js'

    let browser
    (async () => {

        const config =
            {
                genome: 'hg19',

                showCenterGuideButton: true,
                showCenterGuide: true,

                // for multi-locus testing
                // locus: 'chr8:128,750,264-128,750,995',
                locus: 'chr3',
                // locus: 'myc',
                // locus: [ 'ace', 'myc' ],
                tracks:
                    [
                        // {
                        //     "url": "https://www.encodeproject.org/files/ENCFF754TJH/@@download/ENCFF754TJH.bigWig",
                        //     "graphType": "points",
                        //     "pointSize": 3,
                        //     "name": "Encode bigwig points"
                        // },
                        // {
                        //     "name": "SEG Track",
                        //     "url": "https://data.broadinstitute.org/igvdata/test/igv-web/segmented_data_080520.seg.gz",
                        //     "indexed": false,
                        //     "isLog": true,
                        //     "displayMode": "EXPANDED",
                        //     "expandedRowHeight": 20,
                        //     "height": 256,
                        //     "order": 1,
                        //     "format": "seg"
                        // },
                        // {
                        //     "sourceType": "gcs",
                        //     "type": "alignment",
                        //     "url": "gs://genomics-public-data/platinum-genomes/bam/NA12891_S1.bam",
                        //     "indexURL": "gs://genomics-public-data/platinum-genomes/bam/NA12891_S1.bam.bai",
                        //     "name": "NA12891"
                        // }
                    ]
            };

        browser = await igv.createBrowser(document.getElementById('igvDiv'), config)

        await createTrackList(document.getElementById('trackList'), 'testTracks.json', browser)


        document.getElementById("sessionButton").addEventListener("click", () => {
            try {
                const json = browser.toJSON();
                console.log(json);
                const jsonString = JSON.stringify(json, null, '\t');
                const data = URL.createObjectURL(new Blob([jsonString], {type: "application/octet-stream"}));
                download("session.json", data);
            } catch (e) {
                alert(e);
            }
        })

        // programmatic search
        // await browser.search('chr1:153,588,447-153,707,067')
        // const [ locus ] = browser.currentLoci()
        // console.log(`locus ${ locus }`)

        // programatic hide track labels
        // browser.hideTrackLabels()

    })()

    async function createTrackList(div, file, browser) {

        const tracks = await igvxhr.loadJson(file)

        for (let track of tracks) {

            if (track.HEADING) {
                div.insertAdjacentHTML("beforeend",
                    "<div style='cursor:default;background:lightgrey;color:black;margin-left:0; font-weight:bold;font-size: larger'>"
                    + track.HEADING + "</div>");
            } else {
                const trackDiv = document.createElement('div');
                trackDiv.innerHTML = track.name;
                trackDiv.addEventListener('click', () => {

                    // Convert to json to insure we can load json representations (not strictly neccessary).
                    const json = JSON.stringify(track)
                    browser.loadTrack(json)
                });

                div.appendChild(trackDiv);
            }

        }

        div.insertAdjacentHTML("beforeend", "<div style='cursor:default;background:lightgrey;color:black;margin-left:0; font-weight:bold;font-size: larger'>GTEX</div>");

        const { tissueInfo } = await GtexUtils.getTissueInfo("gtex_v7")

        for (let config of tissueInfo) {
            const trackDiv = document.createElement('div')
            trackDiv.innerHTML = (config.tissueSiteDetailId.split('_').join(' '))
            div.appendChild(trackDiv)
            trackDiv.addEventListener('click', () => {
                browser.loadTrack(GtexUtils.trackConfiguration(config))
            })
        }

    }

    function bookmark() {
        window.history.pushState({}, "IGV", browser.sessionURL());
    }

    function download(filename, data) {

        const element = document.createElement('a');
        element.setAttribute('href', data);
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

    document.getElementById("bmBtn").addEventListener("click", bookmark);

</script>
</html>
