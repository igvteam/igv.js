<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Picker</title>
</head>
<body>
<h2>Select file(s) to load.  For indexed formats both data and index files must be selected.</h2>
<input type="file" id="fileInput" multiple>
<p>
<h3>Files:</h3>
    <ul id="fileList"></ul>
</p>


<script>
    const channel = new BroadcastChannel('file_channel')
    const selectedFiles = new Map()


    // Broadcast fileReady if a file is already selected (e.g., after parent refresh)
    function broadcastFileReady() {
        if (selectedFiles.size > 0) {
            channel.postMessage({type: 'fileReady'})
        }
    }

    document.getElementById('fileInput').addEventListener('change', function (event) {
        const files = []

        for (let file of event.target.files) {
            const id = `${file.name}_${file.size}`
            selectedFiles.set(id, file)
            files.push({id, file}) //value)
            document.getElementById("fileList").innerHTML += `<li>${file.name} (${file.size} bytes)</li>`
        }
        broadcastFileReady()

        channel.postMessage({type: 'loadFiles', files: files})

    })

    // Listen for a "whoHasFile" request from any peer (e.g., after parent refresh)
    channel.onmessage = function (event) {
        const {id, type, start, end} = event.data
        const selectedFile = selectedFiles.get(id)
        if (type === 'getBytes' && selectedFile) {
            const file = selectedFiles.get(id)
            const blob = file.slice(start, end)
            channel.postMessage({type: 'byteRange', start, end, data: blob})
        } else if (type === 'getFile' && selectedFile) {
            channel.postMessage({type: 'file', data: selectedFile})
        } else if (type === 'whoHasFile') {
            broadcastFileReady()
        } else if (event.data.type === 'windowID') {
            channel.postMessage({type: 'windowIDResponse', id: window.name})
        } else if (event.data.type === 'filePickerFocus') {
            window.focus()
            channel.postMessage({type: 'focusMeResponse', id: window.name})
        }
    }

    // On load, respond to possible parent refresh
    window.addEventListener('DOMContentLoaded', broadcastFileReady)
</script>
</body>
</html>