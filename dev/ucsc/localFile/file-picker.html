<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Picker</title>
</head>
<body>
<h2>Select a file to send back</h2>
<input type="file" id="fileInput">
<script>
    const channel = new BroadcastChannel('file_channel');
    let selectedFile = null;

    // Broadcast fileReady if a file is already selected (e.g., after parent refresh)
    function broadcastFileReady() {
        if (selectedFile) {
            channel.postMessage({ type: 'fileReady', name: selectedFile.name, size: selectedFile.size });
        }
    }

    document.getElementById('fileInput').addEventListener('change', function(event) {
        selectedFile = event.target.files[0];
        broadcastFileReady();
    });

    // Listen for a "whoHasFile" request from any peer (e.g., after parent refresh)
    channel.onmessage = function(event) {
        const { type, start, end } = event.data;
        if (type === 'getBytes' && selectedFile) {
            const blob = selectedFile.slice(start, end);
            const reader = new FileReader();
            reader.onload = function(e) {
                channel.postMessage({ type: 'byteRange', start, end, data: e.target.result });
            };
            reader.readAsArrayBuffer(blob);
        } else if (type === 'whoHasFile') {
            broadcastFileReady();
        }
    };

    // On load, respond to possible parent refresh
    window.addEventListener('DOMContentLoaded', broadcastFileReady);
</script>
</body>
</html>